# VPS для самых маленьких

> Подробная документация по VPS и защите SSH соединения

---

## Что такое VPS/VDS сервер

VPS (Virtual Private Server) / VDS (Virtual Dedicated Server) — это виртуальный выделенный сервер, к которому клиент получает доступ с помощью удалённого соединения (например, SSH). С точки зрения управления операционной системой такой сервер практически не отличается от физического выделенного сервера и обычно предоставляется с IPv4 или IPv6 адресом.

Технически VPS представляет собой виртуальную машину, запущенную на физическом сервере с использованием технологий виртуализации, таких как KVM, Xen, Hyper-V, VMWare и других. На современном рынке VPS и VDS являются синонимами.

### Параметры при аренде VPS

При аренде VPS у облачных провайдеров/хостеров вы можете выбрать:

- Количество ядер процессора
- Объем оперативной памяти (ОЗУ)
- Дисковое пространство
- Дополнительные характеристики (защита от DDoS-атак, резервное копирование, техническая поддержка)
- Объем интернет-трафика на месяц (лучше выбирать безлимитные варианты)

Серверы арендуются на заданный период времени. Провайдеры предоставляют панель управления для мониторинга состояния сервера, его перезагрузки, смены операционной системы и продления аренды.

---

## Требования к VPS-провайдеру и серверу

При выборе VPS-провайдера и конфигурации сервера рекомендуется учитывать следующие критерии:

### Требования к провайдеру

- **Способы оплаты:** наличие поддержки оплаты удобными для вас методами
- **Географическое расположение:** серверы должны находиться в стабильных странах с хорошим международным сетевым подключением
- **Конфиденциальность:** минимальные требования к персональным данным при регистрации
- **Безопасность:** наличие базовой защиты от DoS-атак и резервного копирования
- **Аптайм (Uptime):** должно быть гарантированное время непрерывной работы не менее 98%

### Требования к техническим характеристикам сервера

- **Диск:** SSD NVME накопитель объемом от 10 ГБ
- **Оперативная память:** минимум 1 ГБ, рекомендуется от 2 ГБ
- **Процессор:** 1-2 ядра с частотой от 3 ГГц на современных процессорах
- **Трафик:** безлимитный или не менее 3 ТБ в месяц
- **Сетевое подключение:** пропускная способность канала от 100 Мбит/с
- **Операционная система:** рекомендуется ubuntu 22.04 / 24.04
- **IP-адрес:** статический IP-адрес в стране размещения сервера

---

## Базовая настройка и обеспечение безопасности сервера

После получения доступа к VPS-серверу необходимо выполнить ряд действий для повышения безопасности системы. 

> **Важно:** Без этих мер ваш сервер будет уязвим для автоматических атак, которые постоянно сканируют интернет в поисках незащищенных серверов.

### 1. Смена пароля суперпользователя (root)

По умолчанию многие провайдеры устанавливают простой или автоматически сгенерированный пароль для пользователя root. Это делает сервер легкой мишенью для атак.

```bash
passwd
```

**Требования к надежному паролю:**

- Длина от 15-20 символов
- Сочетание заглавных и строчных букв
- Наличие цифр и специальных символов
- Отсутствие связи с вашей личной информацией
- Уникальность (не используется нигде еще)

> **Пример хорошего пароля:** `Minecraft_eto_moja_jizn'2024!!!2402`

### 2. Обновление системы

Регулярное обновление пакетов системы критически важно для безопасности, так как в новых версиях исправляются известные уязвимости.

```bash
apt update && apt upgrade -y && reboot
```

### 3. Защита SSH соединения

SSH (Secure Shell) — основной способ удаленного доступа к серверу. В будущем мы будем использовать только данный тип подключения к терминалу VPS. Для защиты необходимо выполнить несколько шагов:

#### 3.1. Создание нового пользователя

Во-первых, необходимо создать обычного пользователя с ограниченными правами, а не использовать root для повседневной работы. (user_name меняете на предпочтительный)

```bash
adduser user_name
```

Следуйте инструкциям на экране, обязательно установив пароль для пользователя. Остальные поля можно оставить пустыми.

**Полезные команды:**

- От обычного пользователя к root: `su -`
- От root к обычному пользователю: `su user_name`

#### 3.2. Настройка SSH конфигурации

Редактируем конфигурационный файл SSH:

```bash
nano /etc/ssh/sshd_config
```

Вносим следующие изменения:

**Изменяем стандартный порт SSH (по умолчанию 22):**

```
Port 2222
```

**Запрещаем вход под пользователем root:**

```
PermitRootLogin no
```

Сохраняем файл (`Ctrl+O`, затем `Enter`) и закрываем редактор (`Ctrl+X`).

После внесения изменений перезапускаем SSH-сервис:

```bash
systemctl restart sshd
```

Теперь подключаться к серверу нужно будет командой:

```bash
ssh -p 2222 user_name@server_ip
```

#### 3.3. Настройка аутентификации по SSH-ключам

Аутентификация по ключам значительно безопаснее парольной аутентификации, так как современные алгоритмы шифрования практически невозможно взломать подбором.

**На клиентском компьютере (Windows):**

Генерируем пару ключей (приватный и публичный):

```bash
ssh-keygen -t ed25519 -C "your_email@example.com"
```

Система спросит:

- Куда сохранить ключи (рекомендуется оставить стандартный путь)
- Нужно ли защитить ключ паролем (если установить пароль, его придется вводить при каждом подключении)

Копируем публичный ключ на сервер:

```bash
cat ~/.ssh/id_ed25519.pub | ssh user_name@server_ip  -p port_number "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"
```

**Для Linux (или WSL):**

```bash
ssh-copy-id -p 2222 user_name@server_ip
```

Проверяем подключение:

```bash
ssh -p 2222 user_name@server_ip
```

Если подключение успешно, настраиваем конфигурационный файл для удобства подключения. Создаем файл конфигурации (на локальной машине):

```bash
mkdir -p ~/.ssh
```

Открываем его в редакторе:

```bash
nano ~/.ssh/config
```

Добавляем следующие настройки:

```
Host myserver
    HostName server_ip
    User user_name
    Port 2222
    IdentityFile ~/.ssh/id_ed25519
    ServerAliveInterval 60
    ServerAliveCountMax 3
    Compression yes
    ControlMaster auto
    ControlPath ~/.ssh/master-%r@%h:%p
```

Теперь можно подключаться простой командой:

```bash
ssh myserver
```

#### 3.4. Отключение аутентификации по паролю

После успешной настройки ключей рекомендуется полностью отключить аутентификацию по паролю:

```bash
sudo nano /etc/ssh/sshd_config
```

Находим и изменяем следующие параметры:

```
PasswordAuthentication no
ChallengeResponseAuthentication no
```

Сохраняем файл и перезапускаем SSH:

```bash
sudo systemctl restart sshd
```

### 4. Установка и настройка Fail2ban

Fail2ban — программа для защиты сервера от атак методом перебора паролей (brute-force). Она анализирует логи сервера и автоматически блокирует IP-адреса, с которых производится множество неудачных попыток входа.

**Установка Fail2ban:**

```bash
sudo apt install fail2ban -y
```

**Проверка статуса:**

```bash
sudo systemctl status fail2ban
```

**По умолчанию Fail2ban:**

- Блокирует IP-адрес на 10 минут после 5 неудачных попыток входа
- Использует стандартные настройки для SSH-защиты

**Настройка Fail2ban:**

Редактируем основной конфигурационный файл:

```bash
sudo nano /etc/fail2ban/jail.local
```

**Важные параметры для настройки:**

- `bantime` — время блокировки в секундах (по умолчанию 600 = 10 минут)
- `findtime` — временной интервал для подсчета неудачных попыток
- `maxretry` — количество неудачных попыток перед блокировкой
- `port` — порт для защиты (должен соответствовать вашему SSH-порту)

Пример настройки для SSH:

```ini
[sshd]
enabled = true
port = 2222
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 3600
findtime = 600
```

После внесения изменений перезапускаем службу:

```bash
sudo systemctl restart fail2ban
```

**Полезные команды для управления Fail2ban:**

- Просмотр заблокированных IP: `fail2ban-client status sshd`
- Разблокировка IP: `fail2ban-client set sshd unbanip IP_ADDRESS`
- Проверка логов: `tail -f /var/log/fail2ban.log`

### 5. Установка необходимых пакетов

Для удобства администрирования сервера рекомендуется установить следующие пакеты:

```bash
sudo apt install git nmap net-tools curl -y
```

**Описание пакетов:**

- `git` — система контроля версий для скачивания программного обеспечения
- `nmap` — утилита для сканирования сетей и проверки открытых портов
- `net-tools` — набор сетевых утилит (включает ifconfig, netstat)
- `curl` — утилита для выполнения HTTP-запросов из командной строки

---

## Проверка безопасности сервера

После выполнения всех настроек рекомендуется провести проверку безопасности:

**1. Проверка открытых портов:**

```bash
sudo nmap -sT -O localhost
```

На сервере должны быть открыты только необходимые порты (SSH на вашем нестандартном порту).

**2. Проверка настроек SSH:**

```bash
sshd -T | grep -E 'passwordauthentication|permitrootlogin|port'
```

В выводе убедитесь, что используется аутентификация по ключам, а не по паролю.

---

## Заключение
### Основные принципы безопасности

- Никогда не используйте учетные данные по умолчанию
- Регулярно обновляйте систему и программное обеспечение
- Минимизируйте количество открытых портов
- Используйте аутентификацию по ключам вместо паролей
- Внедряйте системы обнаружения вторжений (Fail2ban)
- Следите за логами системы на предмет подозрительной активности

> **Помните:** Безопасность — это непрерывный процесс, а не разовое действие. Регулярно проверяйте настройки безопасности и обновляйте их.